# 🚀 KOR.AI Surveillance Platform - Production Deployment Guide

This guide provides complete instructions for deploying the KOR.AI Surveillance Platform to AWS with production-grade CI/CD pipelines.

## 📋 Architecture Overview

### **Current Repository Structure**
This is a **mixed repository** containing both frontend (React/Vite) and backend (Flask) code:

```
kor-ai-core/
├── src/                    # React frontend + Flask backend
├── package.json           # Frontend dependencies (created)
├── vite.config.js         # Vite configuration
├── Dockerfile             # Backend containerization
├── requirements.txt       # Python dependencies
├── .github/workflows/     # CI/CD pipelines (created)
├── deployment/            # AWS infrastructure templates
└── tests/e2e/            # End-to-end tests (created)
```

### **Deployment Architecture**

```
┌─────────────────┐    ┌──────────────────┐    ┌─────────────────┐
│   GitHub Repo   │────│  GitHub Actions  │────│   AWS Services  │
│                 │    │                  │    │                 │
│ • Frontend Code │    │ • Frontend CI/CD │    │ • AWS Amplify   │
│ • Backend Code  │    │ • Backend CI/CD  │    │ • ECS Fargate   │
│ • E2E Tests     │    │ • E2E Testing    │    │ • ECR Registry  │
└─────────────────┘    └──────────────────┘    └─────────────────┘
```

**Production URLs:**
- **Frontend**: `https://korinsic.com`
- **Backend API**: `https://api.korinsic.com`
- **Staging**: `https://staging.korinsic.com` & `https://api-staging.korinsic.com`

---

## 🛠️ Prerequisites

### **Required Tools**
```bash
# Install AWS CLI
curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"
unzip awscliv2.zip && sudo ./aws/install

# Install Docker
curl -fsSL https://get.docker.com -o get-docker.sh
sh get-docker.sh

# Install Node.js 18+
curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
sudo apt-get install -y nodejs
```

### **AWS Account Setup**
1. **AWS Account** with appropriate permissions
2. **Domain registered** (korinsic.com) with Route 53 or external DNS
3. **AWS CLI configured** with credentials

```bash
aws configure
# AWS Access Key ID: [Your Access Key]
# AWS Secret Access Key: [Your Secret Key]
# Default region name: us-east-1
# Default output format: json
```

---

## 🚀 Quick Start Deployment

### **1. One-Command Infrastructure Setup**

```bash
# Clone and setup
git clone <your-repo-url>
cd kor-ai-core

# Run the automated setup script
./scripts/deploy/setup-aws-infrastructure.sh
```

This script will:
- ✅ Create SSL certificates
- ✅ Deploy AWS infrastructure (ECS, ECR, ALB, VPC)
- ✅ Setup Amplify for frontend
- ✅ Build and push initial Docker image
- ✅ Generate environment variables for CI/CD

### **2. Configure GitHub Secrets**

After running the setup script, configure these GitHub repository secrets:

```bash
# From infrastructure.env file generated by setup script
AWS_ACCESS_KEY_ID=<your-aws-access-key>
AWS_SECRET_ACCESS_KEY=<your-aws-secret-key>
ECR_REPOSITORY_URI=<ecr-repo-uri>
AMPLIFY_APP_ID_STAGING=<amplify-staging-app-id>
AMPLIFY_APP_ID_PRODUCTION=<amplify-production-app-id>
VITE_API_BASE_URL=https://api.korinsic.com
```

### **3. Deploy**

```bash
# Deploy to staging
git push origin develop

# Deploy to production
git push origin main
```

---

## 🏗️ Manual Infrastructure Setup

If you prefer manual setup or need customization:

### **Step 1: Deploy AWS Infrastructure**

```bash
# Deploy infrastructure stack
aws cloudformation deploy \
  --template-file deployment/aws-infrastructure.yml \
  --stack-name kor-ai-infrastructure-production \
  --parameter-overrides \
    Environment=production \
    DomainName=korinsic.com \
    CertificateArn=<your-certificate-arn> \
  --capabilities CAPABILITY_IAM \
  --region us-east-1
```

### **Step 2: Setup ECR and Push Image**

```bash
# Get ECR login
aws ecr get-login-password --region us-east-1 | \
  docker login --username AWS --password-stdin <account-id>.dkr.ecr.us-east-1.amazonaws.com

# Build and push
docker build -t kor-ai-core .
docker tag kor-ai-core:latest <ecr-uri>:latest
docker push <ecr-uri>:latest
```

### **Step 3: Setup AWS Amplify**

```bash
# Create Amplify app
aws amplify create-app \
  --name kor-ai-production \
  --repository <github-repo-url> \
  --platform WEB \
  --build-spec file://deployment/amplify.yml

# Add custom domain
aws amplify create-domain-association \
  --app-id <app-id> \
  --domain-name korinsic.com
```

---

## 🔄 CI/CD Pipeline Details

### **Frontend Pipeline** (`.github/workflows/frontend-deploy.yml`)

**Triggers:**
- Push to `main` (production) or `develop` (staging)
- Changes to frontend files (`src/**`, `package.json`, etc.)

**Steps:**
1. **Test**: Lint, unit tests, build validation
2. **Deploy Staging**: Auto-deploy to staging.korinsic.com on `develop` push
3. **Deploy Production**: Auto-deploy to korinsic.com on `main` push

### **Backend Pipeline** (`.github/workflows/backend-deploy.yml`)

**Triggers:**
- Push to `main` (production) or `develop` (staging)
- Changes to backend files (`src/**`, `requirements.txt`, `Dockerfile`)

**Steps:**
1. **Test**: Python linting, unit tests, coverage
2. **Build & Push**: Docker image to ECR
3. **Deploy**: Update ECS service with new image

### **E2E Testing Pipeline** (`.github/workflows/e2e-tests.yml`)

**Triggers:**
- All pushes and PRs
- Scheduled daily runs
- Manual trigger

**Features:**
- Full frontend + backend integration testing
- Multi-browser testing (Chrome, Firefox, Safari)
- Mobile responsiveness testing
- Performance auditing with Lighthouse

---

## 🧪 Testing Strategy

### **Local E2E Testing**

```bash
# Install dependencies
npm ci
pip install -r requirements.txt
pip install -r requirements-dev.txt

# Install Playwright
npx playwright install

# Start backend
export FLASK_ENV=testing
python src/app.py &

# Start frontend
npm run build && npm run preview &

# Run E2E tests
npx playwright test
```

### **Test Routes**

The E2E tests cover:
- ✅ Dashboard loading and navigation
- ✅ API health checks and integration
- ✅ Error handling and loading states
- ✅ Mobile responsiveness
- ✅ Cross-browser compatibility

### **Testing Environments**

- **Local**: `http://localhost:4173` (frontend) + `http://localhost:5000` (backend)
- **Staging**: `https://staging.korinsic.com` + `https://api-staging.korinsic.com`
- **Production**: `https://korinsic.com` + `https://api.korinsic.com`

---

## 🌐 Domain Configuration

### **DNS Records Setup**

Configure these DNS records in your domain provider:

```bash
# Production
korinsic.com          CNAME -> <amplify-domain>
api.korinsic.com      CNAME -> <alb-dns-name>

# Staging
staging.korinsic.com     CNAME -> <amplify-staging-domain>
api-staging.korinsic.com CNAME -> <alb-staging-dns-name>
```

### **SSL Certificate**

The setup script automatically creates ACM certificates for:
- `korinsic.com`
- `*.korinsic.com`

---

## 📊 Monitoring & Observability

### **Built-in Monitoring**

- **CloudWatch Logs**: ECS container logs
- **Application Load Balancer**: Health checks and metrics
- **ECR**: Image vulnerability scanning
- **Amplify**: Build and deployment logs

### **Health Endpoints**

- **Backend Health**: `https://api.korinsic.com/health`
- **Frontend**: Automatic Amplify health checks

### **Rollback Strategy**

```bash
# Backend rollback (revert to previous image)
aws ecs update-service \
  --cluster kor-ai-cluster \
  --service kor-ai-core-production \
  --task-definition kor-ai-core-production:PREVIOUS

# Frontend rollback (revert Amplify deployment)
aws amplify start-job \
  --app-id <app-id> \
  --branch-name main \
  --job-type RELEASE \
  --commit-id <previous-commit-sha>
```

---

## 🔧 Troubleshooting

### **Common Issues**

**1. SSL Certificate Validation**
```bash
# Check certificate status
aws acm describe-certificate --certificate-arn <cert-arn>

# Manual validation required if DNS method used
```

**2. ECS Service Won't Start**
```bash
# Check ECS service events
aws ecs describe-services --cluster kor-ai-cluster --services kor-ai-core-production

# Check CloudWatch logs
aws logs tail /ecs/kor-ai-core-production --follow
```

**3. Amplify Build Failures**
```bash
# Check build logs in Amplify Console
aws amplify list-jobs --app-id <app-id> --branch-name main
```

**4. GitHub Actions Failures**
- Verify all GitHub secrets are set correctly
- Check workflow logs for specific error messages
- Ensure AWS credentials have sufficient permissions

### **Useful Commands**

```bash
# Check infrastructure status
aws cloudformation describe-stacks --stack-name kor-ai-infrastructure-production

# View ECS service status
aws ecs describe-services --cluster kor-ai-cluster --services kor-ai-core-production

# List ECR images
aws ecr list-images --repository-name kor-ai-core

# Check Amplify app status
aws amplify get-app --app-id <app-id>
```

---

## 🔒 Security Considerations

### **Production Security**

- ✅ HTTPS enforced via ALB and Amplify
- ✅ Security headers configured in Amplify
- ✅ VPC with proper security groups
- ✅ ECR image vulnerability scanning
- ✅ IAM roles with least privilege
- ✅ Secrets managed via GitHub Secrets and AWS Parameter Store

### **Environment Variables**

```bash
# Backend (ECS Task Definition)
ENVIRONMENT=production
REDIS_URL=redis://redis-cluster-endpoint:6379
LOG_LEVEL=INFO

# Frontend (Amplify)
VITE_API_BASE_URL=https://api.korinsic.com
```

---

## 📈 Scaling & Performance

### **Auto Scaling**

- **ECS Service**: Auto-scaling based on CPU/Memory
- **Amplify**: Global CDN with automatic scaling
- **Redis**: ElastiCache with automatic failover

### **Performance Optimizations**

- ✅ Docker multi-stage builds
- ✅ Frontend asset optimization via Vite
- ✅ CDN caching via Amplify
- ✅ Database connection pooling
- ✅ Redis caching layer

---

## 🎯 Next Steps

1. **Monitor Performance**: Set up CloudWatch dashboards
2. **Add Alerts**: Configure SNS notifications for failures
3. **Database Setup**: Add RDS if persistent storage needed
4. **Backup Strategy**: Implement automated backups
5. **Cost Optimization**: Review and optimize AWS resource usage

---

## 📞 Support

For deployment issues or questions:
1. Check the troubleshooting section above
2. Review GitHub Actions logs
3. Check AWS CloudWatch logs
4. Verify DNS and SSL certificate configuration

**Infrastructure Costs (Estimated Monthly):**
- ECS Fargate: ~$30-50
- ALB: ~$20
- ECR: ~$1-5
- Amplify: ~$1-15
- ElastiCache: ~$15-30
- **Total**: ~$67-120/month

This deployment setup provides a production-grade, scalable, and maintainable infrastructure for the KOR.AI Surveillance Platform.